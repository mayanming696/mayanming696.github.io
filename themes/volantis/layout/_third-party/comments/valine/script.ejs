<% if (theme.comments.valine.js) { %>
  <%- js(theme.comments.valine.js) %>
<% } else if(theme.use_cdn) { %>
  <%- js(['https://cdn.jsdelivr.net/npm/hexo-theme-volantis@'+theme.info.theme_version+'/source/js/valine.min.js']) %>
<% } else { %>
  <%- js(['js/valine.js']) %>
<% } %>
<script>
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var meta = '<%= theme.comments.valine.meta %>'.split(',').filter(function (item) {
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick', 'mail', 'link'];
  var requiredFields = '<%= theme.comments.valine.requiredFields %>'.split(',').filter(function (item) {
    return REQUIRED_FIELDS.indexOf(item) > -1
  });

  function emoji(path, idx, ext) {
    return path + "/" + path + "-" + idx + "." + ext;
  }

  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }

  function pjax_valine() {
    if(!document.querySelectorAll("#valine_container")[0])return;

    let pagePlaceholder = pdata.commentPlaceholder || "<%= theme.comments.valine.placeholder %>";

    let path = pdata.commentPath;
    if (path.length == 0) {
      let defaultPath = '<%= theme.comments.valine.path %>';
      path = defaultPath || decodeURI(window.location.pathname);
    }

    var valine = new Valine();
    valine.init({
      el: '#valine_container',
      meta: meta,
      placeholder: pagePlaceholder,
      path: path,
      appId: "<%= theme.comments.valine.appId %>",
      appKey: "<%= theme.comments.valine.appKey %>",
      pageSize: '<%= theme.comments.valine.pageSize %>',
      avatar: '<%= theme.comments.valine.avatar %>',
      lang: '<%= theme.comments.valine.lang %>',
      visitor: '<%= theme.comments.valine.visitor %>',
      highlight: '<%= theme.comments.valine.highlight %>',
      mathJax: '<%= theme.comments.valine.mathJax %>',
      enableQQ: '<%= theme.comments.valine.enableQQ %>',
      recordIP: '<%= theme.comments.valine.recordIP %>',
      requiredFields: requiredFields,
      emojiCDN: 'https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/valine/',
      emojiMaps: emojiMaps
    })
  }

  $(function () {
    pjax_valine();
  });
</script>
<script>
  var pushLink ="https://push.xuthus.cc/send/67eb07bd92c31cdc8fc2cb9922aac939";
  var siteName = "W4J1e's blog";
  var valineButton=document.getElementsByClassName("vsubmit vbtn")[0];
  var title = siteName + "上又有新评论啦~!\n";

  function send_valine() {
    //获取元素信息
    var pagename = document.title;
    var pageurl = document.URL;
    var pushtime = new Date();
    var vnick = document.getElementsByClassName("vnick vinput")[0].value;
    var vmail = document.getElementsByClassName("vmail vinput")[0].value;
    var vlink = document.getElementsByClassName("vlink vinput")[0].value;
    var veditor = document.getElementsByClassName("veditor vinput")[0].value;
    content =
      title +
      "昵称：" + vnick +
      "\n邮箱：" + vmail +
      "\n网站地址：" + vlink +
      "\n文章标题：" + pagename +
      "\n评论内容：" + veditor +
      "\n文章链接：" + pageurl +
      "\n评论时间" + pushtime.toLocaleString() + "\n";
    var httpRequest = new XMLHttpRequest(); //第一步：创建需要的对象
    httpRequest.open("POST", pushLink, true); //第二步：打开连接
    httpRequest.setRequestHeader(
      "Content-type",
      "application/json"
    ); //设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）
    httpRequest.send(content); //发送请求 
  }

  document.body.addEventListener('click', function(e) {
  if(e.target.className.indexOf('vsubmit') === -1) {
    return;
  }
  send_valine();
})
</script>
